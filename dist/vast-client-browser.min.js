var VAST=function(e){"use strict";function r(e){return(r="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e})(e)}function l(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function i(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}function n(e,t,r){return t&&i(e.prototype,t),r&&i(e,r),e}function a(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&s(e,t)}function c(e){return(c=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function s(e,t){return(s=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function u(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e):t}var o=function e(){l(this,e),this.id=null,this.sequence=null,this.system=null,this.title=null,this.description=null,this.advertiser=null,this.pricing=null,this.survey=null,this.errorURLTemplates=[],this.impressionURLTemplates=[],this.creatives=[],this.extensions=[]},h=function(){function e(){l(this,e),this.name=null,this.value=null,this.attributes={},this.children=[]}return n(e,[{key:"isEmpty",value:function(){return null===this.value&&0===Object.keys(this.attributes).length&&0===this.children.length}}]),e}(),p=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};l(this,e),this.id=t.id||null,this.width=t.width||0,this.height=t.height||0,this.assetWidth=t.assetWidth||null,this.assetHeight=t.assetHeight||null,this.expandedWidth=t.expandedWidth||null,this.expandedHeight=t.expandedHeight||null,this.apiFramework=t.apiFramework||null,this.adSlotID=t.adSlotID||null,this.staticResources=[],this.htmlResources=[],this.iframeResources=[],this.adParameters=null,this.xmlEncoded=null,this.altText=null,this.companionClickThroughURLTemplate=null,this.companionClickTrackingURLTemplates=[],this.trackingEvents={}},t=function e(){var t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};l(this,e),this.id=t.id||null,this.adId=t.adId||null,this.sequence=t.sequence||null,this.apiFramework=t.apiFramework||null},d=function(e){function r(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return l(this,r),(e=u(this,c(r).call(this,t))).type="companion",e.required=null,e.variations=[],e}return a(r,t),r}();function v(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{},i=[];for(var n in t.ASSETURI&&(t.ASSETURI=m(t.ASSETURI)),t.CONTENTPLAYHEAD&&(t.CONTENTPLAYHEAD=m(t.CONTENTPLAYHEAD)),!t.ERRORCODE||r.isCustomCode||/^[0-9]{3}$/.test(t.ERRORCODE)||(t.ERRORCODE=900),t.CACHEBUSTING=f(Math.round(1e8*Math.random()).toString()),t.TIMESTAMP=m((new Date).toISOString()),t.RANDOM=t.random=t.CACHEBUSTING,e){var a=e[n];if("string"==typeof a){for(var s in t){var o=t[s],l="[".concat(s,"]"),c="%%".concat(s,"%%");a=(a=a.replace(l,o)).replace(c,o)}i.push(a)}}return i}function m(e){return encodeURIComponent(e).replace(/[!'()*]/g,function(e){return"%".concat(e.charCodeAt(0).toString(16))})}function f(e){return e.length<8?g(0,8-e.length,!1).map(function(){return"0"}).join("")+e:e}function g(e,t,r){for(var i=[],n=e<t,a=r?n?t+1:t-1:t,s=e;n?s<a:a<s;n?s++:s--)i.push(s);return i}var T={track:function(e,t,r){v(e,t,r).forEach(function(e){"undefined"!=typeof window&&null!==window&&((new Image).src=e)})},resolveURLTemplates:v,encodeURIComponentRFC3986:m,leftpad:f,range:g,isNumeric:function(e){return!isNaN(parseFloat(e))&&isFinite(e)},flatten:function r(e){return e.reduce(function(e,t){return e.concat(Array.isArray(t)?r(t):t)},[])}};var k={childByName:function(e,t){var r=e.childNodes;for(var i in r){var n=r[i];if(n.nodeName===t)return n}},childrenByName:function(e,t){var r=[],i=e.childNodes;for(var n in i){var a=i[n];a.nodeName===t&&r.push(a)}return r},resolveVastAdTagURI:function(e,t){if(!t)return e;if(0===e.indexOf("//")){var r=location.protocol;return"".concat(r).concat(e)}if(-1!==e.indexOf("://"))return e;var i=t.slice(0,t.lastIndexOf("/"));return"".concat(i,"/").concat(e)},parseBoolean:function(e){return-1!==["true","TRUE","1"].indexOf(e)},parseNodeText:function(e){return e&&(e.textContent||e.text||"").trim()},copyNodeAttribute:function(e,t,r){var i=t.getAttribute(e);i&&r.setAttribute(e,i)},parseAttributes:function(e){for(var t=e.attributes,r={},i=0;i<t.length;i++)r[t[i].nodeName]=t[i].nodeValue;return r},parseDuration:function(e){if(null==e)return-1;if(T.isNumeric(e))return parseInt(e);var t=e.split(":");if(3!==t.length)return-1;var r=t[2].split("."),i=parseInt(r[0]);2===r.length&&(i+=parseFloat("0.".concat(r[1])));var n=parseInt(60*t[1]),a=parseInt(60*t[0]*60);return isNaN(a)||isNaN(n)||isNaN(i)||3600<n||60<i?-1:a+n+i},splitVAST:function(i){var n=[],a=null;return i.forEach(function(e,t){if(e.sequence&&(e.sequence=parseInt(e.sequence,10)),1<e.sequence){var r=i[t-1];if(r&&r.sequence===e.sequence-1)return void(a&&a.push(e));delete e.sequence}a=[e],n.push(a)}),n},mergeWrapperAdData:function(e,i){e.errorURLTemplates=i.errorURLTemplates.concat(e.errorURLTemplates),e.impressionURLTemplates=i.impressionURLTemplates.concat(e.impressionURLTemplates),e.extensions=i.extensions.concat(e.extensions),e.creatives.forEach(function(e){if(i.trackingEvents&&i.trackingEvents[e.type])for(var t in i.trackingEvents[e.type]){var r=i.trackingEvents[e.type][t];Array.isArray(e.trackingEvents[t])||(e.trackingEvents[t]=[]),e.trackingEvents[t]=e.trackingEvents[t].concat(r)}}),i.videoClickTrackingURLTemplates&&i.videoClickTrackingURLTemplates.length&&e.creatives.forEach(function(e){"linear"===e.type&&(e.videoClickTrackingURLTemplates=e.videoClickTrackingURLTemplates.concat(i.videoClickTrackingURLTemplates))}),i.videoCustomClickURLTemplates&&i.videoCustomClickURLTemplates.length&&e.creatives.forEach(function(e){"linear"===e.type&&(e.videoCustomClickURLTemplates=e.videoCustomClickURLTemplates.concat(i.videoCustomClickURLTemplates))}),i.videoClickThroughURLTemplate&&e.creatives.forEach(function(e){"linear"!==e.type||null!==e.videoClickThroughURLTemplate&&void 0!==e.videoClickThroughURLTemplate||(e.videoClickThroughURLTemplate=i.videoClickThroughURLTemplate)})}};var y=function(e){function r(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return l(this,r),(e=u(this,c(r).call(this,t))).type="linear",e.duration=0,e.skipDelay=null,e.mediaFiles=[],e.videoClickThroughURLTemplate=null,e.videoClickTrackingURLTemplates=[],e.videoCustomClickURLTemplates=[],e.adParameters=null,e.icons=[],e.trackingEvents={},e}return a(r,t),r}(),R=function e(){l(this,e),this.program=null,this.height=0,this.width=0,this.xPosition=0,this.yPosition=0,this.apiFramework=null,this.offset=null,this.duration=0,this.type=null,this.staticResource=null,this.htmlResource=null,this.iframeResource=null,this.iconClickThroughURLTemplate=null,this.iconClickTrackingURLTemplates=[],this.iconViewTrackingURLTemplate=null},A=function e(){l(this,e),this.id=null,this.fileURL=null,this.deliveryType="progressive",this.mimeType=null,this.codec=null,this.bitrate=0,this.minBitrate=0,this.maxBitrate=0,this.width=0,this.height=0,this.apiFramework=null,this.scalable=null,this.maintainAspectRatio=null};function L(e,t){var i,a=new y(t);a.duration=k.parseDuration(k.parseNodeText(k.childByName(e,"Duration")));var r=e.getAttribute("skipoffset");if(null==r)a.skipDelay=null;else if("%"===r.charAt(r.length-1)&&-1!==a.duration){var n=parseInt(r,10);a.skipDelay=a.duration*(n/100)}else a.skipDelay=k.parseDuration(r);var s=k.childByName(e,"VideoClicks");s&&(a.videoClickThroughURLTemplate=k.parseNodeText(k.childByName(s,"ClickThrough")),k.childrenByName(s,"ClickTracking").forEach(function(e){a.videoClickTrackingURLTemplates.push(k.parseNodeText(e))}),k.childrenByName(s,"CustomClick").forEach(function(e){a.videoCustomClickURLTemplates.push(k.parseNodeText(e))}));var o=k.childByName(e,"AdParameters");o&&(a.adParameters=k.parseNodeText(o)),k.childrenByName(e,"TrackingEvents").forEach(function(e){k.childrenByName(e,"Tracking").forEach(function(e){var t=e.getAttribute("event"),r=k.parseNodeText(e);if(t&&r){if("progress"===t){if(!(i=e.getAttribute("offset")))return;t="%"===i.charAt(i.length-1)?"progress-".concat(i):"progress-".concat(Math.round(k.parseDuration(i)))}Array.isArray(a.trackingEvents[t])||(a.trackingEvents[t]=[]),a.trackingEvents[t].push(r)}})}),k.childrenByName(e,"MediaFiles").forEach(function(e){k.childrenByName(e,"MediaFile").forEach(function(e){var t=new A;t.id=e.getAttribute("id"),t.fileURL=k.parseNodeText(e),t.deliveryType=e.getAttribute("delivery"),t.codec=e.getAttribute("codec"),t.mimeType=e.getAttribute("type"),t.apiFramework=e.getAttribute("apiFramework"),t.bitrate=parseInt(e.getAttribute("bitrate")||0),t.minBitrate=parseInt(e.getAttribute("minBitrate")||0),t.maxBitrate=parseInt(e.getAttribute("maxBitrate")||0),t.width=parseInt(e.getAttribute("width")||0),t.height=parseInt(e.getAttribute("height")||0);var r=e.getAttribute("scalable");r&&"string"==typeof r&&("true"===(r=r.toLowerCase())?t.scalable=!0:"false"===r&&(t.scalable=!1));var i=e.getAttribute("maintainAspectRatio");i&&"string"==typeof i&&("true"===(i=i.toLowerCase())?t.maintainAspectRatio=!0:"false"===i&&(t.maintainAspectRatio=!1)),a.mediaFiles.push(t)})});var l=k.childByName(e,"Icons");return l&&k.childrenByName(l,"Icon").forEach(function(e){var t,r,i=new R;i.program=e.getAttribute("program"),i.height=parseInt(e.getAttribute("height")||0),i.width=parseInt(e.getAttribute("width")||0),i.xPosition=(t=e.getAttribute("xPosition"),-1===["left","right"].indexOf(t)?parseInt(t||0):t),i.yPosition=(r=e.getAttribute("yPosition"),-1===["top","bottom"].indexOf(r)?parseInt(r||0):r),i.apiFramework=e.getAttribute("apiFramework"),i.offset=k.parseDuration(e.getAttribute("offset")),i.duration=k.parseDuration(e.getAttribute("duration")),k.childrenByName(e,"HTMLResource").forEach(function(e){i.type=e.getAttribute("creativeType")||"text/html",i.htmlResource=k.parseNodeText(e)}),k.childrenByName(e,"IFrameResource").forEach(function(e){i.type=e.getAttribute("creativeType")||0,i.iframeResource=k.parseNodeText(e)}),k.childrenByName(e,"StaticResource").forEach(function(e){i.type=e.getAttribute("creativeType")||0,i.staticResource=k.parseNodeText(e)});var n=k.childByName(e,"IconClicks");n&&(i.iconClickThroughURLTemplate=k.parseNodeText(k.childByName(n,"IconClickThrough")),k.childrenByName(n,"IconClickTracking").forEach(function(e){i.iconClickTrackingURLTemplates.push(k.parseNodeText(e))})),i.iconViewTrackingURLTemplate=k.parseNodeText(k.childByName(e,"IconViewTracking")),a.icons.push(i)}),a}var E=function(e){function r(){var e,t=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};return l(this,r),(e=u(this,c(r).call(this,t))).type="nonlinear",e.variations=[],e.trackingEvents={},e}return a(r,t),r}(),U=function e(){l(this,e),this.id=null,this.width=0,this.height=0,this.expandedWidth=0,this.expandedHeight=0,this.scalable=!0,this.maintainAspectRatio=!0,this.minSuggestedDuration=0,this.apiFramework="static",this.type=null,this.staticResource=null,this.htmlResource=null,this.iframeResource=null,this.nonlinearClickThroughURLTemplate=null,this.nonlinearClickTrackingURLTemplates=[],this.adParameters=null};function N(e,t){var i=new E(t);return k.childrenByName(e,"TrackingEvents").forEach(function(e){var t,r;k.childrenByName(e,"Tracking").forEach(function(e){t=e.getAttribute("event"),r=k.parseNodeText(e),t&&r&&(Array.isArray(i.trackingEvents[t])||(i.trackingEvents[t]=[]),i.trackingEvents[t].push(r))})}),k.childrenByName(e,"NonLinear").forEach(function(e){var t=new U;t.id=e.getAttribute("id")||null,t.width=e.getAttribute("width"),t.height=e.getAttribute("height"),t.expandedWidth=e.getAttribute("expandedWidth"),t.expandedHeight=e.getAttribute("expandedHeight"),t.scalable=k.parseBoolean(e.getAttribute("scalable")),t.maintainAspectRatio=k.parseBoolean(e.getAttribute("maintainAspectRatio")),t.minSuggestedDuration=k.parseDuration(e.getAttribute("minSuggestedDuration")),t.apiFramework=e.getAttribute("apiFramework"),k.childrenByName(e,"HTMLResource").forEach(function(e){t.type=e.getAttribute("creativeType")||"text/html",t.htmlResource=k.parseNodeText(e)}),k.childrenByName(e,"IFrameResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.iframeResource=k.parseNodeText(e)}),k.childrenByName(e,"StaticResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.staticResource=k.parseNodeText(e)});var r=k.childByName(e,"AdParameters");r&&(t.adParameters=k.parseNodeText(r)),t.nonlinearClickThroughURLTemplate=k.parseNodeText(k.childByName(e,"NonLinearClickThrough")),k.childrenByName(e,"NonLinearClickTracking").forEach(function(e){t.nonlinearClickTrackingURLTemplates.push(k.parseNodeText(e))}),i.variations.push(t)}),i}function w(e){var t=e.childNodes;for(var r in t){var i=t[r];if(-1!==["Wrapper","InLine"].indexOf(i.nodeName)){if(k.copyNodeAttribute("id",e,i),k.copyNodeAttribute("sequence",e,i),"Wrapper"===i.nodeName)return b(i);if("InLine"===i.nodeName)return C(i)}}}function C(e){var t=e.childNodes,l=new o;for(var r in l.id=e.getAttribute("id")||null,l.sequence=e.getAttribute("sequence")||null,t){var i=t[r];switch(i.nodeName){case"Error":l.errorURLTemplates.push(k.parseNodeText(i));break;case"Impression":l.impressionURLTemplates.push(k.parseNodeText(i));break;case"Creatives":k.childrenByName(i,"Creative").forEach(function(e){var t,r,i,n={id:e.getAttribute("id")||null,adId:(t=e,t.getAttribute("AdID")||t.getAttribute("adID")||t.getAttribute("adId")||null),sequence:e.getAttribute("sequence")||null,apiFramework:e.getAttribute("apiFramework")||null};for(var a in e.childNodes){var s=e.childNodes[a],o=void 0;switch(s.nodeName){case"Linear":(o=L(s,n))&&l.creatives.push(o);break;case"NonLinearAds":(o=N(s,n))&&l.creatives.push(o);break;case"CompanionAds":r=s,i=void 0,(i=new d(n)).required=r.getAttribute("required")||null,i.variations=k.childrenByName(r,"Companion").map(function(e){var i=new p(k.parseAttributes(e));i.htmlResources=k.childrenByName(e,"HTMLResource").reduce(function(e,t){var r=k.parseNodeText(t);return r?e.concat(r):e},[]),i.iframeResources=k.childrenByName(e,"IFrameResource").reduce(function(e,t){var r=k.parseNodeText(t);return r?e.concat(r):e},[]),i.staticResources=k.childrenByName(e,"StaticResource").reduce(function(e,t){var r=k.parseNodeText(t);return r?e.concat({url:r,creativeType:t.getAttribute("creativeType")||null}):e},[]),i.altText=k.parseNodeText(k.childByName(e,"AltText"))||null;var t=k.childByName(e,"TrackingEvents");t&&k.childrenByName(t,"Tracking").forEach(function(e){var t=e.getAttribute("event"),r=k.parseNodeText(e);t&&r&&(Array.isArray(i.trackingEvents[t])||(i.trackingEvents[t]=[]),i.trackingEvents[t].push(r))}),i.companionClickTrackingURLTemplates=k.childrenByName(e,"CompanionClickTracking").map(function(e){return k.parseNodeText(e)}),i.companionClickThroughURLTemplate=k.parseNodeText(k.childByName(e,"CompanionClickThrough"))||null;var r=k.childByName(e,"AdParameters");return r&&(i.adParameters=k.parseNodeText(r),i.xmlEncoded=r.getAttribute("xmlEncoded")||null),i}),(o=i)&&l.creatives.push(o)}}});break;case"Extensions":l.extensions=x(k.childrenByName(i,"Extension"));break;case"AdSystem":l.system={value:k.parseNodeText(i),version:i.getAttribute("version")||null};break;case"AdTitle":l.title=k.parseNodeText(i);break;case"Description":l.description=k.parseNodeText(i);break;case"Advertiser":l.advertiser=k.parseNodeText(i);break;case"Pricing":l.pricing={value:k.parseNodeText(i),model:i.getAttribute("model")||null,currency:i.getAttribute("currency")||null};break;case"Survey":l.survey=k.parseNodeText(i)}}return l}function b(e){var i=C(e),t=k.childByName(e,"VASTAdTagURI");if(t?i.nextWrapperURL=k.parseNodeText(t):(t=k.childByName(e,"VASTAdTagURL"))&&(i.nextWrapperURL=k.parseNodeText(k.childByName(t,"URL"))),i.creatives.forEach(function(r){if(-1!==["linear","nonlinear"].indexOf(r.type)){if(r.trackingEvents){i.trackingEvents||(i.trackingEvents={}),i.trackingEvents[r.type]||(i.trackingEvents[r.type]={});var e=function(t){var e=r.trackingEvents[t];Array.isArray(i.trackingEvents[r.type][t])||(i.trackingEvents[r.type][t]=[]),e.forEach(function(e){i.trackingEvents[r.type][t].push(e)})};for(var t in r.trackingEvents)e(t)}r.videoClickTrackingURLTemplates&&(Array.isArray(i.videoClickTrackingURLTemplates)||(i.videoClickTrackingURLTemplates=[]),r.videoClickTrackingURLTemplates.forEach(function(e){i.videoClickTrackingURLTemplates.push(e)})),r.videoClickThroughURLTemplate&&(i.videoClickThroughURLTemplate=r.videoClickThroughURLTemplate),r.videoCustomClickURLTemplates&&(Array.isArray(i.videoCustomClickURLTemplates)||(i.videoCustomClickURLTemplates=[]),r.videoCustomClickURLTemplates.forEach(function(e){i.videoCustomClickURLTemplates.push(e)}))}}),i.nextWrapperURL)return i}function x(e){var r=[];return e.forEach(function(e){var t=function e(t){if("#comment"===t.nodeName)return null;var r=new h;var i=t.attributes;var n=t.childNodes;r.name=t.nodeName;if(t.attributes)for(var a in i)if(i.hasOwnProperty(a)){var s=i[a];s.nodeName&&s.nodeValue&&(r.attributes[s.nodeName]=s.nodeValue)}for(var o in n)if(n.hasOwnProperty(o)){var l=e(n[o]);l&&r.children.push(l)}if(0===r.children.length||1===r.children.length&&0<=["#cdata-section","#text"].indexOf(r.children[0].name)){var c=k.parseNodeText(t);""!==c&&(r.value=c),r.children=[]}return r.isEmpty()?null:r}(e);t&&r.push(t)}),r}var S=function(){function e(){l(this,e),this._handlers=[]}return n(e,[{key:"on",value:function(e,t){if("function"!=typeof t)throw new TypeError("The handler argument must be of type Function. Received type ".concat(r(t)));if(!e)throw new TypeError("The event argument must be of type String. Received type ".concat(r(e)));return this._handlers.push({event:e,handler:t}),this}},{key:"once",value:function(e,t){return this.on(e,function(e,t,r){var i={fired:!1,wrapFn:void 0};function n(){i.fired||(e.off(t,i.wrapFn),i.fired=!0,r.bind(e).apply(void 0,arguments))}return i.wrapFn=n}(this,e,t))}},{key:"off",value:function(t,r){return this._handlers=this._handlers.filter(function(e){return e.event!==t||e.handler!==r}),this}},{key:"emit",value:function(t){for(var e=arguments.length,r=new Array(1<e?e-1:0),i=1;i<e;i++)r[i-1]=arguments[i];var n=!1;return this._handlers.forEach(function(e){"*"===e.event&&(n=!0,e.handler.apply(e,[t].concat(r))),e.event===t&&(n=!0,e.handler.apply(e,r))}),n}},{key:"removeAllListeners",value:function(t){return this._handlers=t?this._handlers.filter(function(e){return e.event!==t}):[],this}},{key:"listenerCount",value:function(t){return this._handlers.filter(function(e){return e.event===t}).length}},{key:"listeners",value:function(r){return this._handlers.reduce(function(e,t){return t.event===r&&e.push(t.handler),e},[])}},{key:"eventNames",value:function(){return this._handlers.map(function(e){return e.event})}}]),e}();function I(){var e;return window.XDomainRequest&&(e=new XDomainRequest),e}var D={get:function(e,t,r){var i="function"==typeof window.ActiveXObject?new window.ActiveXObject("Microsoft.XMLDOM"):void 0;if(!i)return r(new Error("FlashURLHandler: Microsoft.XMLDOM format not supported"));i.async=!1;var n=I();n.open("GET",e),n.timeout=t.timeout||0,n.withCredentials=t.withCredentials||!1,n.send(),n.onprogress=function(){},n.onload=function(){i.loadXML(n.responseText),r(null,i)}},supported:function(){return!!I()}};var O={get:function(e,t,r){r(new Error("Please bundle the library for node to use the node urlHandler"))}};function B(){try{var e=new window.XMLHttpRequest;return"withCredentials"in e?e:null}catch(e){return null}}var F={get:function(e,t,r){if("https:"===window.location.protocol&&0===e.indexOf("http://"))return r(new Error("XHRURLHandler: Cannot go from HTTPS to HTTP."));try{var i=B();i.open("GET",e),i.timeout=t.timeout||0,i.withCredentials=t.withCredentials||!1,i.overrideMimeType&&i.overrideMimeType("text/xml"),i.onreadystatechange=function(){4===i.readyState&&(200===i.status?r(null,i.responseXML):r(new Error("XHRURLHandler: ".concat(i.statusText))))},i.send()}catch(e){r(new Error("XHRURLHandler: Unexpected error"))}},supported:function(){return!!B()}};var P={get:function(e,t,r){return r||("function"==typeof t&&(r=t),t={}),"undefined"==typeof window||null===window?O.get(e,t,r):F.supported()?F.get(e,t,r):D.supported()?D.get(e,t,r):r(new Error("Current context is not supported by any of the default URLHandlers. Please provide a custom URLHandler"))}},V=function e(){l(this,e),this.ads=[],this.errorURLTemplates=[]},M={ERRORCODE:900,extensions:[]},H=function(e){function t(){var e;return l(this,t),(e=u(this,c(t).call(this))).remainingAds=[],e.parentURLs=[],e.errorURLTemplates=[],e.rootErrorURLTemplates=[],e.maxWrapperDepth=null,e.URLTemplateFilters=[],e.fetchingOptions={},e}return a(t,S),n(t,[{key:"addURLTemplateFilter",value:function(e){"function"==typeof e&&this.URLTemplateFilters.push(e)}},{key:"removeURLTemplateFilter",value:function(){this.URLTemplateFilters.pop()}},{key:"countURLTemplateFilters",value:function(){return this.URLTemplateFilters.length}},{key:"clearURLTemplateFilters",value:function(){this.URLTemplateFilters=[]}},{key:"trackVastError",value:function(e,t){for(var r=arguments.length,i=new Array(2<r?r-2:0),n=2;n<r;n++)i[n-2]=arguments[n];this.emit("VAST-error",Object.assign.apply(Object,[M,t].concat(i))),T.track(e,t)}},{key:"getErrorURLTemplates",value:function(){return this.rootErrorURLTemplates.concat(this.errorURLTemplates)}},{key:"fetchVAST",value:function(n,e,t){var a=this;return new Promise(function(r,i){a.URLTemplateFilters.forEach(function(e){n=e(n)}),a.parentURLs.push(n),a.emit("VAST-resolving",{url:n,wrapperDepth:e,originalUrl:t}),a.urlHandler.get(n,a.fetchingOptions,function(e,t){a.emit("VAST-resolved",{url:n,error:e}),e?i(e):r(t)})})}},{key:"initParsingStatus",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:{};this.rootURL="",this.remainingAds=[],this.parentURLs=[],this.errorURLTemplates=[],this.rootErrorURLTemplates=[],this.maxWrapperDepth=e.wrapperLimit||10,this.fetchingOptions={timeout:e.timeout,withCredentials:e.withCredentials},this.urlHandler=e.urlHandler||e.urlhandler||P}},{key:"getRemainingAds",value:function(e){var t=this;if(0===this.remainingAds.length)return Promise.reject(new Error("No more ads are available for the given VAST"));var r=e?T.flatten(this.remainingAds):this.remainingAds.shift();return this.errorURLTemplates=[],this.parentURLs=[],this.resolveAds(r,{wrapperDepth:0,originalUrl:this.rootURL}).then(function(e){return t.buildVASTResponse(e)})}},{key:"getAndParseVAST",value:function(t){var r=this,i=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return this.initParsingStatus(i),this.rootURL=t,this.fetchVAST(t).then(function(e){return i.originalUrl=t,i.isRootVAST=!0,r.parse(e,i).then(function(e){return r.buildVASTResponse(e)})})}},{key:"parseVAST",value:function(e){var t=this,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{};return this.initParsingStatus(r),r.isRootVAST=!0,this.parse(e,r).then(function(e){return t.buildVASTResponse(e)})}},{key:"buildVASTResponse",value:function(e){var t=new V;return t.ads=e,t.errorURLTemplates=this.getErrorURLTemplates(),this.completeWrapperResolving(t),t}},{key:"parseVastXml",value:function(e,t){var r=t.isRootVAST,i=void 0!==r&&r;if(!e||!e.documentElement||"VAST"!==e.documentElement.nodeName)throw new Error("Invalid VAST XMLDocument");var n=[],a=e.documentElement.childNodes;for(var s in a){var o=a[s];if("Error"===o.nodeName){var l=k.parseNodeText(o);i?this.rootErrorURLTemplates.push(l):this.errorURLTemplates.push(l)}if("Ad"===o.nodeName){var c=w(o);c?n.push(c):this.trackVastError(this.getErrorURLTemplates(),{ERRORCODE:101})}}return n}},{key:"parse",value:function(e,t){var r=t.resolveAll,i=void 0===r||r,n=t.wrapperSequence,a=void 0===n?null:n,s=t.originalUrl,o=void 0===s?null:s,l=t.wrapperDepth,c=void 0===l?0:l,u=t.isRootVAST,h=void 0!==u&&u,p=[];try{p=this.parseVastXml(e,{isRootVAST:h})}catch(e){return Promise.reject(e)}var d=p.length,v=p[d-1];return 1===d&&null!=a&&v&&!v.sequence&&(v.sequence=a),!1===i&&(this.remainingAds=k.splitVAST(p),p=this.remainingAds.shift()),this.resolveAds(p,{wrapperDepth:c,originalUrl:o})}},{key:"resolveAds",value:function(){var i=this,e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:[],t=1<arguments.length?arguments[1]:void 0,n=t.wrapperDepth,a=t.originalUrl,r=[];return e.forEach(function(e){var t=i.resolveWrappers(e,n,a);r.push(t)}),Promise.all(r).then(function(e){var t=T.flatten(e);if(!t&&0<i.remainingAds.length){var r=i.remainingAds.shift();return i.resolveAds(r,{wrapperDepth:n,originalUrl:a})}return t})}},{key:"resolveWrappers",value:function(i,n,a){var s=this;return new Promise(function(t){if(n++,!i.nextWrapperURL)return delete i.nextWrapperURL,t(i);if(n>=s.maxWrapperDepth||-1!==s.parentURLs.indexOf(i.nextWrapperURL))return i.errorCode=302,delete i.nextWrapperURL,t(i);i.nextWrapperURL=k.resolveVastAdTagURI(i.nextWrapperURL,a);var r=i.sequence;a=i.nextWrapperURL,s.fetchVAST(i.nextWrapperURL,n,a).then(function(e){return s.parse(e,{originalUrl:a,wrapperSequence:r,wrapperDepth:n}).then(function(e){if(delete i.nextWrapperURL,0===e.length)return i.creatives=[],t(i);e.forEach(function(e){e&&k.mergeWrapperAdData(e,i)}),t(e)})}).catch(function(e){i.errorCode=301,i.errorMessage=e.message,t(i)})})}},{key:"completeWrapperResolving",value:function(e){if(0===e.ads.length)this.trackVastError(e.errorURLTemplates,{ERRORCODE:303});else for(var t=e.ads.length-1;0<=t;t--){var r=e.ads[t];(r.errorCode||0===r.creatives.length)&&(this.trackVastError(r.errorURLTemplates.concat(e.errorURLTemplates),{ERRORCODE:r.errorCode||303},{ERRORMESSAGE:r.errorMessage||""},{extensions:r.extensions},{system:r.system}),e.ads.splice(t,1))}}}]),t}(),W=null,q={data:{},length:0,getItem:function(e){return this.data[e]},setItem:function(e,t){this.data[e]=t,this.length=Object.keys(this.data).length},removeItem:function(e){delete this.data[e],this.length=Object.keys(this.data).length},clear:function(){this.data={},this.length=0}},_=function(){function e(){l(this,e),this.storage=this.initStorage()}return n(e,[{key:"initStorage",value:function(){if(W)return W;try{W="undefined"!=typeof window&&null!==window?window.localStorage||window.sessionStorage:null}catch(e){W=null}return W&&!this.isStorageDisabled(W)||(W=q).clear(),W}},{key:"isStorageDisabled",value:function(e){var t="__VASTStorage__";try{if(e.setItem(t,t),e.getItem(t)!==t)return e.removeItem(t),!0}catch(e){return!0}return e.removeItem(t),!1}},{key:"getItem",value:function(e){return this.storage.getItem(e)}},{key:"setItem",value:function(e,t){return this.storage.setItem(e,t)}},{key:"removeItem",value:function(e){return this.storage.removeItem(e)}},{key:"clear",value:function(){return this.storage.clear()}}]),e}(),j=function(){function i(e,t,r){l(this,i),this.cappingFreeLunch=e||0,this.cappingMinimumTimeInterval=t||0,this.defaultOptions={withCredentials:!1,timeout:0},this.vastParser=new H,this.storage=r||new _,void 0===this.lastSuccessfulAd&&(this.lastSuccessfulAd=0),void 0===this.totalCalls&&(this.totalCalls=0),void 0===this.totalCallsTimeout&&(this.totalCallsTimeout=0)}return n(i,[{key:"getParser",value:function(){return this.vastParser}},{key:"hasRemainingAds",value:function(){return 0<this.vastParser.remainingAds.length}},{key:"getNextAds",value:function(e){return this.vastParser.getRemainingAds(e)}},{key:"get",value:function(i){var n=this,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},s=Date.now();return(a=Object.assign(this.defaultOptions,a)).hasOwnProperty("resolveAll")||(a.resolveAll=!1),this.totalCallsTimeout<s?(this.totalCalls=1,this.totalCallsTimeout=s+36e5):this.totalCalls++,new Promise(function(t,r){if(n.cappingFreeLunch>=n.totalCalls)return r(new Error("VAST call canceled – FreeLunch capping not reached yet ".concat(n.totalCalls,"/").concat(n.cappingFreeLunch)));var e=s-n.lastSuccessfulAd;if(e<0)n.lastSuccessfulAd=0;else if(e<n.cappingMinimumTimeInterval)return r(new Error("VAST call canceled – (".concat(n.cappingMinimumTimeInterval,")ms minimum interval reached")));n.vastParser.getAndParseVAST(i,a).then(function(e){return t(e)}).catch(function(e){return r(e)})})}},{key:"lastSuccessfulAd",get:function(){return this.storage.getItem("vast-client-last-successful-ad")},set:function(e){this.storage.setItem("vast-client-last-successful-ad",e)}},{key:"totalCalls",get:function(){return this.storage.getItem("vast-client-total-calls")},set:function(e){this.storage.setItem("vast-client-total-calls",e)}},{key:"totalCallsTimeout",get:function(){return this.storage.getItem("vast-client-total-calls-timeout")},set:function(e){this.storage.setItem("vast-client-total-calls-timeout",e)}}]),i}(),X=function(e){function o(e,t,r){var i,n=3<arguments.length&&void 0!==arguments[3]?arguments[3]:null;for(var a in l(this,o),(i=u(this,c(o).call(this))).ad=t,i.creative=r,i.variation=n,i.muted=!1,i.impressed=!1,i.skippable=!1,i.trackingEvents={},i._alreadyTriggeredQuartiles={},i.emitAlwaysEvents=["creativeView","start","firstQuartile","midpoint","thirdQuartile","complete","resume","pause","rewind","skip","closeLinear","close"],i.creative.trackingEvents){var s=i.creative.trackingEvents[a];i.trackingEvents[a]=s.slice(0)}return i.creative instanceof y?i._initLinearTracking():i._initVariationTracking(),e&&i.on("start",function(){e.lastSuccessfulAd=Date.now()}),i}return a(o,S),n(o,[{key:"_initLinearTracking",value:function(){this.linear=!0,this.skipDelay=this.creative.skipDelay,this.setDuration(this.creative.duration),this.clickThroughURLTemplate=this.creative.videoClickThroughURLTemplate,this.clickTrackingURLTemplates=this.creative.videoClickTrackingURLTemplates}},{key:"_initVariationTracking",value:function(){if(this.linear=!1,this.skipDelay=-1,this.variation){for(var e in this.variation.trackingEvents){var t=this.variation.trackingEvents[e];this.trackingEvents[e]?this.trackingEvents[e]=this.trackingEvents[e].concat(t.slice(0)):this.trackingEvents[e]=t.slice(0)}this.variation instanceof U?(this.clickThroughURLTemplate=this.variation.nonlinearClickThroughURLTemplate,this.clickTrackingURLTemplates=this.variation.nonlinearClickTrackingURLTemplates,this.setDuration(this.variation.minSuggestedDuration)):this.variation instanceof p&&(this.clickThroughURLTemplate=this.variation.companionClickThroughURLTemplate,this.clickTrackingURLTemplates=this.variation.companionClickTrackingURLTemplates)}}},{key:"setDuration",value:function(e){this.assetDuration=e,this.quartiles={firstQuartile:Math.round(25*this.assetDuration)/100,midpoint:Math.round(50*this.assetDuration)/100,thirdQuartile:Math.round(75*this.assetDuration)/100}}},{key:"setProgress",value:function(e){var t=this,r=this.skipDelay||-1;if(-1===r||this.skippable||(e<r?this.emit("skip-countdown",r-e):(this.skippable=!0,this.emit("skip-countdown",0))),0<this.assetDuration){var i=[];if(0<e){var n=Math.round(e/this.assetDuration*100);for(var a in i.push("start"),i.push("progress-".concat(n,"%")),i.push("progress-".concat(Math.round(e))),this.quartiles)this.isQuartileReached(a,this.quartiles[a],e)&&(i.push(a),this._alreadyTriggeredQuartiles[a]=!0)}i.forEach(function(e){t.track(e,!0)}),e<this.progress&&this.track("rewind")}this.progress=e}},{key:"isQuartileReached",value:function(e,t,r){var i=!1;return t<=r&&!this._alreadyTriggeredQuartiles[e]&&(i=!0),i}},{key:"setMuted",value:function(e){this.muted!==e&&this.track(e?"mute":"unmute"),this.muted=e}},{key:"setPaused",value:function(e){this.paused!==e&&this.track(e?"pause":"resume"),this.paused=e}},{key:"setFullscreen",value:function(e){this.fullscreen!==e&&this.track(e?"fullscreen":"exitFullscreen"),this.fullscreen=e}},{key:"setExpand",value:function(e){this.expanded!==e&&this.track(e?"expand":"collapse"),this.expanded=e}},{key:"setSkipDelay",value:function(e){"number"==typeof e&&(this.skipDelay=e)}},{key:"trackImpression",value:function(){this.impressed||(this.impressed=!0,this.trackURLs(this.ad.impressionURLTemplates),this.track("creativeView"))}},{key:"errorWithCode",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];this.trackURLs(this.ad.errorURLTemplates,{ERRORCODE:e},{isCustomCode:t})}},{key:"complete",value:function(){this.track("complete")}},{key:"close",value:function(){this.track(this.linear?"closeLinear":"close")}},{key:"skip",value:function(){this.track("skip")}},{key:"click",value:function(){var e=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;this.clickTrackingURLTemplates&&this.clickTrackingURLTemplates.length&&this.trackURLs(this.clickTrackingURLTemplates);var t=this.clickThroughURLTemplate||e;if(t){var r=this.linear?{CONTENTPLAYHEAD:this.progressFormatted()}:{},i=T.resolveURLTemplates([t],r)[0];this.emit("clickthrough",i)}}},{key:"track",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]&&arguments[1];"closeLinear"===e&&!this.trackingEvents[e]&&this.trackingEvents.close&&(e="close");var r=this.trackingEvents[e],i=-1<this.emitAlwaysEvents.indexOf(e);r?(this.emit(e,""),this.trackURLs(r)):i&&this.emit(e,""),t&&(delete this.trackingEvents[e],i&&this.emitAlwaysEvents.splice(this.emitAlwaysEvents.indexOf(e),1))}},{key:"trackURLs",value:function(e){var t=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{},r=2<arguments.length&&void 0!==arguments[2]?arguments[2]:{};this.linear&&(this.creative&&this.creative.mediaFiles&&this.creative.mediaFiles[0]&&this.creative.mediaFiles[0].fileURL&&(t.ASSETURI=this.creative.mediaFiles[0].fileURL),t.CONTENTPLAYHEAD=this.progressFormatted()),T.track(e,t,r)}},{key:"progressFormatted",value:function(){var e=parseInt(this.progress),t=e/3600;t.length<2&&(t="0".concat(t));var r=e/60%60;r.length<2&&(r="0".concat(r));var i=e%60;i.length<2&&(i="0".concat(r));var n=parseInt(100*(this.progress-e));return"".concat(t,":").concat(r,":").concat(i,".").concat(n)}}]),o}();return e.VASTClient=j,e.VASTParser=H,e.VASTTracker=X,e}({});
