var VAST=function(e){"use strict";var t=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")},r=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}(),i=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)},n=function(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t},s=function e(){t(this,e),this.name=null,this.value=null,this.attributes={}},a=function e(){t(this,e),this.id=null,this.width=0,this.height=0,this.type=null,this.staticResource=null,this.htmlResource=null,this.iframeResource=null,this.altText=null,this.companionClickThroughURLTemplate=null,this.companionClickTrackingURLTemplates=[],this.trackingEvents={}},o=function e(){var r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,e),this.id=r.id||null,this.adId=r.adId||null,this.sequence=r.sequence||null,this.apiFramework=r.apiFramework||null,this.trackingEvents={}},l=function(e){function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,r);var i=n(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return i.type="companion",i.variations=[],i}return i(r,o),r}(),u=function(){function e(){t(this,e)}return r(e,[{key:"track",value:function(e,t){this.resolveURLTemplates(e,t).forEach(function(e){"undefined"!=typeof window&&null!==window&&((new Image).src=e)})}},{key:"resolveURLTemplates",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},r=[];for(var i in t.ASSETURI&&(t.ASSETURI=this.encodeURIComponentRFC3986(t.ASSETURI)),t.CONTENTPLAYHEAD&&(t.CONTENTPLAYHEAD=this.encodeURIComponentRFC3986(t.CONTENTPLAYHEAD)),t.ERRORCODE&&!/^[0-9]{3}$/.test(t.ERRORCODE)&&(t.ERRORCODE=900),t.CACHEBUSTING=this.leftpad(Math.round(1e8*Math.random()).toString()),t.TIMESTAMP=this.encodeURIComponentRFC3986((new Date).toISOString()),t.RANDOM=t.random=t.CACHEBUSTING,e){var n=e[i];if(n){for(var s in t){var a=t[s],o="["+s+"]",l="%%"+s+"%%";n=(n=n.replace(o,a)).replace(l,a)}r.push(n)}}return r}},{key:"encodeURIComponentRFC3986",value:function(e){return encodeURIComponent(e).replace(/[!'()*]/g,function(e){return"%"+e.charCodeAt(0).toString(16)})}},{key:"leftpad",value:function(e){return e.length<8?this.range(0,8-e.length,!1).map(function(e){return"0"}).join("")+e:e}},{key:"range",value:function(e,t,r){for(var i=[],n=e<t,s=r?n?t+1:t-1:t,a=e;n?a<s:a>s;n?a++:a--)i.push(a);return i}},{key:"isNumeric",value:function(e){return!isNaN(parseFloat(e))&&isFinite(e)}},{key:"flatten",value:function(e){var t=this;return e.reduce(function(e,r){return e.concat(Array.isArray(r)?t.flatten(r):r)},[])}}]),e}(),c=function(){function e(){t(this,e),this.util=new u}return r(e,[{key:"childByName",value:function(e,t){var r=e.childNodes;for(var i in r){var n=r[i];if(n.nodeName===t)return n}}},{key:"childrenByName",value:function(e,t){var r=[],i=e.childNodes;for(var n in i){var s=i[n];s.nodeName===t&&r.push(s)}return r}},{key:"resolveVastAdTagURI",value:function(e,t){return t?0===e.indexOf("//")?""+location.protocol+e:-1===e.indexOf("://")?t.slice(0,t.lastIndexOf("/"))+"/"+e:e:e}},{key:"parseBoolean",value:function(e){return-1!==["true","TRUE","1"].indexOf(e)}},{key:"parseNodeText",value:function(e){return e&&(e.textContent||e.text||"").trim()}},{key:"copyNodeAttribute",value:function(e,t,r){var i=t.getAttribute(e);i&&r.setAttribute(e,i)}},{key:"parseDuration",value:function(e){if(null==e)return-1;if(this.util.isNumeric(e))return parseInt(e);var t=e.split(":");if(3!==t.length)return-1;var r=t[2].split("."),i=parseInt(r[0]);2===r.length&&(i+=parseFloat("0."+r[1]));var n=parseInt(60*t[1]),s=parseInt(60*t[0]*60);return isNaN(s)||isNaN(n)||isNaN(i)||n>3600||i>60?-1:s+n+i}},{key:"splitVAST",value:function(e){var t=[],r=null;return e.forEach(function(i,n){if(i.sequence&&(i.sequence=parseInt(i.sequence,10)),i.sequence>1){var s=e[n-1];if(s&&s.sequence===i.sequence-1)return void(r&&r.push(i));delete i.sequence}r=[i],t.push(r)}),t}}]),e}(),h=function(){function e(){t(this,e),this.parserUtils=new c}return r(e,[{key:"parse",value:function(e,t){var r=this,i=new l(t);return this.parserUtils.childrenByName(e,"Companion").forEach(function(e){var t=new a;t.id=e.getAttribute("id")||null,t.width=e.getAttribute("width"),t.height=e.getAttribute("height"),t.companionClickTrackingURLTemplates=[],r.parserUtils.childrenByName(e,"HTMLResource").forEach(function(e){t.type=e.getAttribute("creativeType")||"text/html",t.htmlResource=r.parserUtils.parseNodeText(e)}),r.parserUtils.childrenByName(e,"IFrameResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.iframeResource=r.parserUtils.parseNodeText(e)}),r.parserUtils.childrenByName(e,"StaticResource").forEach(function(i){t.type=i.getAttribute("creativeType")||0,r.parserUtils.childrenByName(e,"AltText").forEach(function(e){t.altText=r.parserUtils.parseNodeText(e)}),t.staticResource=r.parserUtils.parseNodeText(i)}),r.parserUtils.childrenByName(e,"TrackingEvents").forEach(function(e){r.parserUtils.childrenByName(e,"Tracking").forEach(function(e){var i=e.getAttribute("event"),n=r.parserUtils.parseNodeText(e);i&&n&&(null==t.trackingEvents[i]&&(t.trackingEvents[i]=[]),t.trackingEvents[i].push(n))})}),r.parserUtils.childrenByName(e,"CompanionClickTracking").forEach(function(e){t.companionClickTrackingURLTemplates.push(r.parserUtils.parseNodeText(e))}),t.companionClickThroughURLTemplate=r.parserUtils.parseNodeText(r.parserUtils.childByName(e,"CompanionClickThrough")),t.companionClickTrackingURLTemplate=r.parserUtils.parseNodeText(r.parserUtils.childByName(e,"CompanionClickTracking")),i.variations.push(t)}),i}}]),e}(),p=function(e){function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,r);var i=n(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return i.type="linear",i.duration=0,i.skipDelay=null,i.mediaFiles=[],i.videoClickThroughURLTemplate=null,i.videoClickTrackingURLTemplates=[],i.videoCustomClickURLTemplates=[],i.adParameters=null,i.icons=[],i}return i(r,o),r}(),d=function(){function e(){t(this,e),this.parserUtils=new c}return r(e,[{key:"parse",value:function(e,r){var i=this,n=void 0,s=new p(r);s.duration=this.parserUtils.parseDuration(this.parserUtils.parseNodeText(this.parserUtils.childByName(e,"Duration")));var a=e.getAttribute("skipoffset");if(null==a)s.skipDelay=null;else if("%"===a.charAt(a.length-1)&&-1!==s.duration){var o=parseInt(a,10);s.skipDelay=s.duration*(o/100)}else s.skipDelay=this.parserUtils.parseDuration(a);var l=this.parserUtils.childByName(e,"VideoClicks");l&&(s.videoClickThroughURLTemplate=this.parserUtils.parseNodeText(this.parserUtils.childByName(l,"ClickThrough")),this.parserUtils.childrenByName(l,"ClickTracking").forEach(function(e){s.videoClickTrackingURLTemplates.push(i.parserUtils.parseNodeText(e))}),this.parserUtils.childrenByName(l,"CustomClick").forEach(function(e){s.videoCustomClickURLTemplates.push(i.parserUtils.parseNodeText(e))}));var u=this.parserUtils.childByName(e,"AdParameters");u&&(s.adParameters=this.parserUtils.parseNodeText(u)),this.parserUtils.childrenByName(e,"TrackingEvents").forEach(function(e){i.parserUtils.childrenByName(e,"Tracking").forEach(function(e){var t=e.getAttribute("event"),r=i.parserUtils.parseNodeText(e);if(t&&r){if("progress"===t){if(!(n=e.getAttribute("offset")))return;t="%"===n.charAt(n.length-1)?"progress-"+n:"progress-"+Math.round(i.parserUtils.parseDuration(n))}null==s.trackingEvents[t]&&(s.trackingEvents[t]=[]),s.trackingEvents[t].push(r)}})}),this.parserUtils.childrenByName(e,"MediaFiles").forEach(function(e){i.parserUtils.childrenByName(e,"MediaFile").forEach(function(e){var r=new function e(){t(this,e),this.id=null,this.fileURL=null,this.deliveryType="progressive",this.mimeType=null,this.codec=null,this.bitrate=0,this.minBitrate=0,this.maxBitrate=0,this.width=0,this.height=0,this.apiFramework=null,this.scalable=null,this.maintainAspectRatio=null};r.id=e.getAttribute("id"),r.fileURL=i.parserUtils.parseNodeText(e),r.deliveryType=e.getAttribute("delivery"),r.codec=e.getAttribute("codec"),r.mimeType=e.getAttribute("type"),r.apiFramework=e.getAttribute("apiFramework"),r.bitrate=parseInt(e.getAttribute("bitrate")||0),r.minBitrate=parseInt(e.getAttribute("minBitrate")||0),r.maxBitrate=parseInt(e.getAttribute("maxBitrate")||0),r.width=parseInt(e.getAttribute("width")||0),r.height=parseInt(e.getAttribute("height")||0);var n=e.getAttribute("scalable");n&&"string"==typeof n&&("true"===(n=n.toLowerCase())?r.scalable=!0:"false"===n&&(r.scalable=!1));var a=e.getAttribute("maintainAspectRatio");a&&"string"==typeof a&&("true"===(a=a.toLowerCase())?r.maintainAspectRatio=!0:"false"===a&&(r.maintainAspectRatio=!1)),s.mediaFiles.push(r)})});var c=this.parserUtils.childByName(e,"Icons");return c&&this.parserUtils.childrenByName(c,"Icon").forEach(function(e){var r=new function e(){t(this,e),this.program=null,this.height=0,this.width=0,this.xPosition=0,this.yPosition=0,this.apiFramework=null,this.offset=null,this.duration=0,this.type=null,this.staticResource=null,this.htmlResource=null,this.iframeResource=null,this.iconClickThroughURLTemplate=null,this.iconClickTrackingURLTemplates=[],this.iconViewTrackingURLTemplate=null};r.program=e.getAttribute("program"),r.height=parseInt(e.getAttribute("height")||0),r.width=parseInt(e.getAttribute("width")||0),r.xPosition=i.parseXPosition(e.getAttribute("xPosition")),r.yPosition=i.parseYPosition(e.getAttribute("yPosition")),r.apiFramework=e.getAttribute("apiFramework"),r.offset=i.parserUtils.parseDuration(e.getAttribute("offset")),r.duration=i.parserUtils.parseDuration(e.getAttribute("duration")),i.parserUtils.childrenByName(e,"HTMLResource").forEach(function(e){r.type=e.getAttribute("creativeType")||"text/html",r.htmlResource=i.parserUtils.parseNodeText(e)}),i.parserUtils.childrenByName(e,"IFrameResource").forEach(function(e){r.type=e.getAttribute("creativeType")||0,r.iframeResource=i.parserUtils.parseNodeText(e)}),i.parserUtils.childrenByName(e,"StaticResource").forEach(function(e){r.type=e.getAttribute("creativeType")||0,r.staticResource=i.parserUtils.parseNodeText(e)});var n=i.parserUtils.childByName(e,"IconClicks");n&&(r.iconClickThroughURLTemplate=i.parserUtils.parseNodeText(i.parserUtils.childByName(n,"IconClickThrough")),i.parserUtils.childrenByName(n,"IconClickTracking").forEach(function(e){r.iconClickTrackingURLTemplates.push(i.parserUtils.parseNodeText(e))})),r.iconViewTrackingURLTemplate=i.parserUtils.parseNodeText(i.parserUtils.childByName(e,"IconViewTracking")),s.icons.push(r)}),s}},{key:"parseXPosition",value:function(e){return-1!==["left","right"].indexOf(e)?e:parseInt(e||0)}},{key:"parseYPosition",value:function(e){return-1!==["top","bottom"].indexOf(e)?e:parseInt(e||0)}}]),e}(),f=function(e){function r(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};t(this,r);var i=n(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,e));return i.type="nonlinear",i.variations=[],i}return i(r,o),r}(),v=function e(){t(this,e),this.id=null,this.width=0,this.height=0,this.expandedWidth=0,this.expandedHeight=0,this.scalable=!0,this.maintainAspectRatio=!0,this.minSuggestedDuration=0,this.apiFramework="static",this.type=null,this.staticResource=null,this.htmlResource=null,this.iframeResource=null,this.nonlinearClickThroughURLTemplate=null,this.nonlinearClickTrackingURLTemplates=[],this.adParameters=null},m=function(){function e(){t(this,e),this.parserUtils=new c}return r(e,[{key:"parse",value:function(e,t){var r=this,i=new f(t);return this.parserUtils.childrenByName(e,"TrackingEvents").forEach(function(e){var t=void 0,n=void 0;r.parserUtils.childrenByName(e,"Tracking").forEach(function(e){t=e.getAttribute("event"),n=r.parserUtils.parseNodeText(e),t&&n&&(null==i.trackingEvents[t]&&(i.trackingEvents[t]=[]),i.trackingEvents[t].push(n))})}),this.parserUtils.childrenByName(e,"NonLinear").forEach(function(e){var t=new v;t.id=e.getAttribute("id")||null,t.width=e.getAttribute("width"),t.height=e.getAttribute("height"),t.expandedWidth=e.getAttribute("expandedWidth"),t.expandedHeight=e.getAttribute("expandedHeight"),t.scalable=r.parserUtils.parseBoolean(e.getAttribute("scalable")),t.maintainAspectRatio=r.parserUtils.parseBoolean(e.getAttribute("maintainAspectRatio")),t.minSuggestedDuration=r.parserUtils.parseDuration(e.getAttribute("minSuggestedDuration")),t.apiFramework=e.getAttribute("apiFramework"),r.parserUtils.childrenByName(e,"HTMLResource").forEach(function(e){t.type=e.getAttribute("creativeType")||"text/html",t.htmlResource=r.parserUtils.parseNodeText(e)}),r.parserUtils.childrenByName(e,"IFrameResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.iframeResource=r.parserUtils.parseNodeText(e)}),r.parserUtils.childrenByName(e,"StaticResource").forEach(function(e){t.type=e.getAttribute("creativeType")||0,t.staticResource=r.parserUtils.parseNodeText(e)});var n=r.parserUtils.childByName(e,"AdParameters");n&&(t.adParameters=r.parserUtils.parseNodeText(n)),t.nonlinearClickThroughURLTemplate=r.parserUtils.parseNodeText(r.parserUtils.childByName(e,"NonLinearClickThrough")),r.parserUtils.childrenByName(e,"NonLinearClickTracking").forEach(function(e){t.nonlinearClickTrackingURLTemplates.push(r.parserUtils.parseNodeText(e))}),i.variations.push(t)}),i}}]),e}(),g=function(){function e(){t(this,e),this.creativeCompanionParser=new h,this.creativeNonLinearParser=new m,this.creativeLinearParser=new d,this.parserUtils=new c}return r(e,[{key:"parse",value:function(e){var t=e.childNodes;for(var r in t){var i=t[r];if(-1!==["Wrapper","InLine"].indexOf(i.nodeName)){if(this.parserUtils.copyNodeAttribute("id",e,i),this.parserUtils.copyNodeAttribute("sequence",e,i),"Wrapper"===i.nodeName)return this.parseWrapper(i);if("InLine"===i.nodeName)return this.parseInLine(i)}}}},{key:"parseInLine",value:function(e){var r=this,i=e.childNodes,n=new function e(){t(this,e),this.id=null,this.sequence=null,this.system=null,this.title=null,this.description=null,this.advertiser=null,this.pricing=null,this.survey=null,this.errorURLTemplates=[],this.impressionURLTemplates=[],this.creatives=[],this.extensions=[]};for(var s in n.id=e.getAttribute("id")||null,n.sequence=e.getAttribute("sequence")||null,i){var a=i[s];switch(a.nodeName){case"Error":n.errorURLTemplates.push(this.parserUtils.parseNodeText(a));break;case"Impression":n.impressionURLTemplates.push(this.parserUtils.parseNodeText(a));break;case"Creatives":this.parserUtils.childrenByName(a,"Creative").forEach(function(e){var t={id:e.getAttribute("id")||null,adId:r.parseCreativeAdIdAttribute(e),sequence:e.getAttribute("sequence")||null,apiFramework:e.getAttribute("apiFramework")||null};for(var i in e.childNodes){var s=e.childNodes[i];switch(s.nodeName){case"Linear":var a=r.creativeLinearParser.parse(s,t);a&&n.creatives.push(a);break;case"NonLinearAds":var o=r.creativeNonLinearParser.parse(s,t);o&&n.creatives.push(o);break;case"CompanionAds":var l=r.creativeCompanionParser.parse(s,t);l&&n.creatives.push(l)}}});break;case"Extensions":this.parseExtensions(n.extensions,this.parserUtils.childrenByName(a,"Extension"));break;case"AdSystem":n.system={value:this.parserUtils.parseNodeText(a),version:a.getAttribute("version")||null};break;case"AdTitle":n.title=this.parserUtils.parseNodeText(a);break;case"Description":n.description=this.parserUtils.parseNodeText(a);break;case"Advertiser":n.advertiser=this.parserUtils.parseNodeText(a);break;case"Pricing":n.pricing={value:this.parserUtils.parseNodeText(a),model:a.getAttribute("model")||null,currency:a.getAttribute("currency")||null};break;case"Survey":n.survey=this.parserUtils.parseNodeText(a)}}return n}},{key:"parseWrapper",value:function(e){var t=this.parseInLine(e),r=this.parserUtils.childByName(e,"VASTAdTagURI");if(r?t.nextWrapperURL=this.parserUtils.parseNodeText(r):(r=this.parserUtils.childByName(e,"VASTAdTagURL"))&&(t.nextWrapperURL=this.parserUtils.parseNodeText(this.parserUtils.childByName(r,"URL"))),t.creatives.forEach(function(e){if(-1!==["linear","nonlinear"].indexOf(e.type)){if(e.trackingEvents){t.trackingEvents||(t.trackingEvents={}),t.trackingEvents[e.type]||(t.trackingEvents[e.type]={});var r=function(r){var i=e.trackingEvents[r];t.trackingEvents[e.type][r]||(t.trackingEvents[e.type][r]=[]),i.forEach(function(i){t.trackingEvents[e.type][r].push(i)})};for(var i in e.trackingEvents)r(i)}e.videoClickTrackingURLTemplates&&(t.videoClickTrackingURLTemplates||(t.videoClickTrackingURLTemplates=[]),e.videoClickTrackingURLTemplates.forEach(function(e){t.videoClickTrackingURLTemplates.push(e)})),e.videoClickThroughURLTemplate&&(t.videoClickThroughURLTemplate=e.videoClickThroughURLTemplate),e.videoCustomClickURLTemplates&&(t.videoCustomClickURLTemplates||(t.videoCustomClickURLTemplates=[]),e.videoCustomClickURLTemplates.forEach(function(e){t.videoCustomClickURLTemplates.push(e)}))}}),t.nextWrapperURL)return t}},{key:"parseExtensions",value:function(e,r){var i=this;r.forEach(function(r){var n=new function e(){t(this,e),this.attributes={},this.children=[]},a=r.attributes,o=r.childNodes;if(r.attributes)for(var l in a){var u=a[l];u.nodeName&&u.nodeValue&&(n.attributes[u.nodeName]=u.nodeValue)}for(var c in o){var h=o[c],p=i.parserUtils.parseNodeText(h);if("#comment"!==h.nodeName&&""!==p){var d=new s;if(d.name=h.nodeName,d.value=p,h.attributes){var f=h.attributes;for(var v in f){var m=f[v];d.attributes[m.nodeName]=m.nodeValue}}n.children.push(d)}}e.push(n)})}},{key:"parseCreativeAdIdAttribute",value:function(e){return e.getAttribute("AdID")||e.getAttribute("adID")||e.getAttribute("adId")||null}}]),e}();function T(){}function k(){k.init.call(this)}function y(e){return void 0===e._maxListeners?k.defaultMaxListeners:e._maxListeners}function U(e,t,r,i){var n,s,a,o;if("function"!=typeof r)throw new TypeError('"listener" argument must be a function');if((s=e._events)?(s.newListener&&(e.emit("newListener",t,r.listener?r.listener:r),s=e._events),a=s[t]):(s=e._events=new T,e._eventsCount=0),a){if("function"==typeof a?a=s[t]=i?[r,a]:[a,r]:i?a.unshift(r):a.push(r),!a.warned&&(n=y(e))&&n>0&&a.length>n){a.warned=!0;var l=new Error("Possible EventEmitter memory leak detected. "+a.length+" "+t+" listeners added. Use emitter.setMaxListeners() to increase limit");l.name="MaxListenersExceededWarning",l.emitter=e,l.type=t,l.count=a.length,o=l,"function"==typeof console.warn?console.warn(o):console.log(o)}}else a=s[t]=r,++e._eventsCount;return e}function R(e,t,r){var i=!1;function n(){e.removeListener(t,n),i||(i=!0,r.apply(e,arguments))}return n.listener=r,n}function L(e){var t=this._events;if(t){var r=t[e];if("function"==typeof r)return 1;if(r)return r.length}return 0}function A(e,t){for(var r=new Array(t);t--;)r[t]=e[t];return r}T.prototype=Object.create(null),k.EventEmitter=k,k.usingDomains=!1,k.prototype.domain=void 0,k.prototype._events=void 0,k.prototype._maxListeners=void 0,k.defaultMaxListeners=10,k.init=function(){this.domain=null,k.usingDomains&&(!(void 0).active||this instanceof(void 0).Domain||(this.domain=(void 0).active)),this._events&&this._events!==Object.getPrototypeOf(this)._events||(this._events=new T,this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},k.prototype.setMaxListeners=function(e){if("number"!=typeof e||e<0||isNaN(e))throw new TypeError('"n" argument must be a positive number');return this._maxListeners=e,this},k.prototype.getMaxListeners=function(){return y(this)},k.prototype.emit=function(e){var t,r,i,n,s,a,o,l="error"===e;if(a=this._events)l=l&&null==a.error;else if(!l)return!1;if(o=this.domain,l){if(t=arguments[1],!o){if(t instanceof Error)throw t;var u=new Error('Uncaught, unspecified "error" event. ('+t+")");throw u.context=t,u}return t||(t=new Error('Uncaught, unspecified "error" event')),t.domainEmitter=this,t.domain=o,t.domainThrown=!1,o.emit("error",t),!1}if(!(r=a[e]))return!1;var c="function"==typeof r;switch(i=arguments.length){case 1:!function(e,t,r){if(t)e.call(r);else for(var i=e.length,n=A(e,i),s=0;s<i;++s)n[s].call(r)}(r,c,this);break;case 2:!function(e,t,r,i){if(t)e.call(r,i);else for(var n=e.length,s=A(e,n),a=0;a<n;++a)s[a].call(r,i)}(r,c,this,arguments[1]);break;case 3:!function(e,t,r,i,n){if(t)e.call(r,i,n);else for(var s=e.length,a=A(e,s),o=0;o<s;++o)a[o].call(r,i,n)}(r,c,this,arguments[1],arguments[2]);break;case 4:!function(e,t,r,i,n,s){if(t)e.call(r,i,n,s);else for(var a=e.length,o=A(e,a),l=0;l<a;++l)o[l].call(r,i,n,s)}(r,c,this,arguments[1],arguments[2],arguments[3]);break;default:for(n=new Array(i-1),s=1;s<i;s++)n[s-1]=arguments[s];!function(e,t,r,i){if(t)e.apply(r,i);else for(var n=e.length,s=A(e,n),a=0;a<n;++a)s[a].apply(r,i)}(r,c,this,n)}return!0},k.prototype.addListener=function(e,t){return U(this,e,t,!1)},k.prototype.on=k.prototype.addListener,k.prototype.prependListener=function(e,t){return U(this,e,t,!0)},k.prototype.once=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.on(e,R(this,e,t)),this},k.prototype.prependOnceListener=function(e,t){if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');return this.prependListener(e,R(this,e,t)),this},k.prototype.removeListener=function(e,t){var r,i,n,s,a;if("function"!=typeof t)throw new TypeError('"listener" argument must be a function');if(!(i=this._events))return this;if(!(r=i[e]))return this;if(r===t||r.listener&&r.listener===t)0==--this._eventsCount?this._events=new T:(delete i[e],i.removeListener&&this.emit("removeListener",e,r.listener||t));else if("function"!=typeof r){for(n=-1,s=r.length;s-- >0;)if(r[s]===t||r[s].listener&&r[s].listener===t){a=r[s].listener,n=s;break}if(n<0)return this;if(1===r.length){if(r[0]=void 0,0==--this._eventsCount)return this._events=new T,this;delete i[e]}else!function(e,t){for(var r=t,i=r+1,n=e.length;i<n;r+=1,i+=1)e[r]=e[i];e.pop()}(r,n);i.removeListener&&this.emit("removeListener",e,a||t)}return this},k.prototype.removeAllListeners=function(e){var t,r;if(!(r=this._events))return this;if(!r.removeListener)return 0===arguments.length?(this._events=new T,this._eventsCount=0):r[e]&&(0==--this._eventsCount?this._events=new T:delete r[e]),this;if(0===arguments.length){for(var i,n=Object.keys(r),s=0;s<n.length;++s)"removeListener"!==(i=n[s])&&this.removeAllListeners(i);return this.removeAllListeners("removeListener"),this._events=new T,this._eventsCount=0,this}if("function"==typeof(t=r[e]))this.removeListener(e,t);else if(t)do{this.removeListener(e,t[t.length-1])}while(t[0]);return this},k.prototype.listeners=function(e){var t,r=this._events;return r&&(t=r[e])?"function"==typeof t?[t.listener||t]:function(e){for(var t=new Array(e.length),r=0;r<t.length;++r)t[r]=e[r].listener||e[r];return t}(t):[]},k.listenerCount=function(e,t){return"function"==typeof e.listenerCount?e.listenerCount(t):L.call(e,t)},k.prototype.listenerCount=L,k.prototype.eventNames=function(){return this._eventsCount>0?Reflect.ownKeys(this._events):[]};var w=function(){function e(){t(this,e)}return r(e,[{key:"xdr",value:function(){var e=void 0;return window.XDomainRequest&&(e=new XDomainRequest),e}},{key:"supported",value:function(){return!!this.xdr()}},{key:"get",value:function(e,t,r){var i="function"==typeof window.ActiveXObject?new window.ActiveXObject("Microsoft.XMLDOM"):void 0;if(!i)return r(new Error("FlashURLHandler: Microsoft.XMLDOM format not supported"));i.async=!1;var n=this.xdr();n.open("GET",e),n.timeout=t.timeout||0,n.withCredentials=t.withCredentials||!1,n.send(),n.onprogress=function(){},n.onload=function(){i.loadXML(n.responseText),r(null,i)}}}]),e}(),E=function(){function e(){t(this,e)}return r(e,[{key:"get",value:function(e,t,r){r(new Error("Please bundle the library for node to use the node urlHandler"))}}]),e}(),C=function(){function e(){t(this,e)}return r(e,[{key:"xhr",value:function(){try{var e=new window.XMLHttpRequest;return"withCredentials"in e?e:null}catch(e){return console.log("Error in XHRURLHandler support check:",e),null}}},{key:"supported",value:function(){return!!this.xhr()}},{key:"get",value:function(e,t,r){if("https:"===window.location.protocol&&0===e.indexOf("http://"))return r(new Error("XHRURLHandler: Cannot go from HTTPS to HTTP."));try{var i=this.xhr();i.open("GET",e),i.timeout=t.timeout||0,i.withCredentials=t.withCredentials||!1,i.overrideMimeType&&i.overrideMimeType("text/xml"),i.onreadystatechange=function(){4===i.readyState&&(200===i.status?r(null,i.responseXML):r(new Error("XHRURLHandler: "+i.statusText)))},i.send()}catch(e){r(new Error("XHRURLHandler: Unexpected error"))}}}]),e}(),b=function(){function e(){t(this,e),this.flash=new w,this.node=new E,this.xhr=new C}return r(e,[{key:"get",value:function(e,t,r){return r||("function"==typeof t&&(r=t),t={}),t.urlhandler&&t.urlhandler.supported()?t.urlhandler.get(e,t,r):"undefined"==typeof window||null===window?this.node.get(e,t,r):this.xhr.supported()?this.xhr.get(e,t,r):this.flash.supported()?this.flash.get(e,t,r):r(new Error("Current context is not supported by any of the default URLHandlers. Please provide a custom URLHandler"))}}]),e}(),N={ERRORCODE:900,extensions:[]},x=function(e){function s(){t(this,s);var e=n(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));return e.remainingAds=[],e.parentURLs=[],e.errorURLTemplates=[],e.rootErrorURLTemplates=[],e.maxWrapperDepth=null,e.URLTemplateFilters=[],e.fetchingOptions={},e.parserUtils=new c,e.adParser=new g,e.util=new u,e}return i(s,k),r(s,[{key:"addURLTemplateFilter",value:function(e){"function"==typeof e&&this.URLTemplateFilters.push(e)}},{key:"removeURLTemplateFilter",value:function(){this.URLTemplateFilters.pop()}},{key:"countURLTemplateFilters",value:function(){return this.URLTemplateFilters.length}},{key:"clearURLTemplateFilters",value:function(){this.URLTemplateFilters=[]}},{key:"trackVastError",value:function(e,t){for(var r=arguments.length,i=Array(r>2?r-2:0),n=2;n<r;n++)i[n-2]=arguments[n];this.emit("VAST-error",Object.assign.apply(Object,[N,t].concat(i))),this.util.track(e,t)}},{key:"getErrorURLTemplates",value:function(){return this.rootErrorURLTemplates.concat(this.errorURLTemplates)}},{key:"fetchVAST",value:function(e){var t=this;return new Promise(function(r,i){t.URLTemplateFilters.forEach(function(t){e=t(e)}),t.parentURLs.push(e),t.emit("VAST-resolving",{url:e}),t.urlHandler.get(e,t.fetchingOptions,function(n,s){t.emit("VAST-resolved",{url:e}),n?i(n):r(s)})})}},{key:"initParsingStatus",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};this.rootURL="",this.remainingAds=[],this.parentURLs=[],this.errorURLTemplates=[],this.rootErrorURLTemplates=[],this.maxWrapperDepth=e.wrapperLimit||10,this.fetchingOptions={timeout:e.timeout,withCredentials:e.withCredentials},this.urlHandler=e.urlhandler||new b}},{key:"getRemainingAds",value:function(e){var t=this;return new Promise(function(r,i){if(0===t.remainingAds.length)return i(new Error("No more ads are available for the given VAST"));var n=e?t.util.flatten(t.remainingAds):t.remainingAds.shift();t.errorURLTemplates=[],t.parentURLs=[],t.resolveAds(n,{wrapperDepth:0,originalUrl:t.rootURL}).then(function(e){var i=t.buildVASTResponse(e);r(i)}).catch(function(e){return i(e)})})}},{key:"getAndParseVAST",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.initParsingStatus(r),this.rootURL=e,new Promise(function(i,n){t.fetchVAST(e).then(function(s){r.originalUrl=e,r.isRootVAST=!0,t.parse(s,r).then(function(e){var r=t.buildVASTResponse(e);i(r)}).catch(function(e){return n(e)})}).catch(function(e){return n(e)})})}},{key:"parseVAST",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.initParsingStatus(r),new Promise(function(i,n){r.isRootVAST=!0,t.parse(e,r).then(function(e){var r=t.buildVASTResponse(e);i(r)}).catch(function(e){return n(e)})})}},{key:"buildVASTResponse",value:function(e){var r=new function e(){t(this,e),this.ads=[],this.errorURLTemplates=[]};return r.ads=e,r.errorURLTemplates=this.getErrorURLTemplates(),this.completeWrapperResolving(r),r}},{key:"parse",value:function(e,t){var r=this,i=t.resolveAll,n=void 0===i||i,s=t.wrapperSequence,a=void 0===s?null:s,o=t.originalUrl,l=void 0===o?null:o,u=t.wrapperDepth,c=void 0===u?0:u,h=t.isRootVAST,p=void 0!==h&&h;return new Promise(function(t,i){if(!e||!e.documentElement||"VAST"!==e.documentElement.nodeName)return i(new Error("Invalid VAST XMLDocument"));var s=[],o=e.documentElement.childNodes;for(var u in o){var h=o[u];if("Error"===h.nodeName){var d=r.parserUtils.parseNodeText(h);p?r.rootErrorURLTemplates.push(d):r.errorURLTemplates.push(d)}if("Ad"===h.nodeName){var f=r.adParser.parse(h);f?s.push(f):r.trackVastError(r.getErrorURLTemplates(),{ERRORCODE:101})}}var v=s.length,m=s[v-1];1===v&&void 0!==a&&null!==a&&m&&!m.sequence&&(m.sequence=a),!1===n&&(r.remainingAds=r.parserUtils.splitVAST(s),s=r.remainingAds.shift()),r.resolveAds(s,{resolveAll:n,wrapperDepth:c,originalUrl:l}).then(function(e){return t(e)}).catch(function(e){return i(e)})})}},{key:"resolveAds",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],r=arguments[1],i=r.wrapperDepth,n=r.originalUrl;return new Promise(function(r,s){var a=[];t.forEach(function(t){var r=e.resolveWrappers(t,i,n);a.push(r)}),r(Promise.all(a).then(function(t){return e.util.flatten(t)}))}).then(function(t){if(!t&&e.remainingAds.length>0){var r=e.remainingAds.shift();return e.resolveAds(r,{wrapperDepth:i,originalUrl:n})}return t})}},{key:"resolveWrappers",value:function(e,t,r){var i=this;return new Promise(function(n,s){if(t++,!e.nextWrapperURL)return delete e.nextWrapperURL,n(e);if(t>=i.maxWrapperDepth||-1!==i.parentURLs.indexOf(e.nextWrapperURL))return e.errorCode=302,delete e.nextWrapperURL,n(e);e.nextWrapperURL=i.parserUtils.resolveVastAdTagURI(e.nextWrapperURL,r);var a=e.sequence;r=e.nextWrapperURL,i.fetchVAST(e.nextWrapperURL).then(function(s){i.parse(s,{originalUrl:r,wrapperSequence:a,wrapperDepth:t}).then(function(t){if(delete e.nextWrapperURL,0===t.length)return e.creatives=[],n(e);t.forEach(function(t){t&&i.mergeWrapperAdData(t,e)}),n(t)}).catch(function(t){e.errorCode=301,e.errorMessage=t.message,n(e)})}).catch(function(e){return s(e)})})}},{key:"completeWrapperResolving",value:function(e){if(0===e.ads.length)this.trackVastError(e.errorURLTemplates,{ERRORCODE:303});else for(var t=e.ads.length-1;t>=0;t--){var r=e.ads[t];(r.errorCode||0===r.creatives.length)&&(this.trackVastError(r.errorURLTemplates.concat(e.errorURLTemplates),{ERRORCODE:r.errorCode||303},{ERRORMESSAGE:r.errorMessage||""},{extensions:r.extensions},{system:r.system}),e.ads.splice(t,1))}}},{key:"mergeWrapperAdData",value:function(e,t){e.errorURLTemplates=t.errorURLTemplates.concat(e.errorURLTemplates),e.impressionURLTemplates=t.impressionURLTemplates.concat(e.impressionURLTemplates),e.extensions=t.extensions.concat(e.extensions),e.creatives.forEach(function(e){if(t.trackingEvents&&t.trackingEvents[e.type])for(var r in t.trackingEvents[e.type]){var i=t.trackingEvents[e.type][r];e.trackingEvents[r]||(e.trackingEvents[r]=[]),e.trackingEvents[r]=e.trackingEvents[r].concat(i)}}),t.videoClickTrackingURLTemplates&&t.videoClickTrackingURLTemplates.length&&e.creatives.forEach(function(e){"linear"===e.type&&(e.videoClickTrackingURLTemplates=e.videoClickTrackingURLTemplates.concat(t.videoClickTrackingURLTemplates))}),t.videoCustomClickURLTemplates&&t.videoCustomClickURLTemplates.length&&e.creatives.forEach(function(e){"linear"===e.type&&(e.videoCustomClickURLTemplates=e.videoCustomClickURLTemplates.concat(t.videoCustomClickURLTemplates))}),t.videoClickThroughURLTemplate&&e.creatives.forEach(function(e){"linear"===e.type&&null==e.videoClickThroughURLTemplate&&(e.videoClickThroughURLTemplate=t.videoClickThroughURLTemplate)})}}]),s}(),I=null,S={data:{},length:0,getItem:function(e){return this.data[e]},setItem:function(e,t){this.data[e]=t,this.length=Object.keys(this.data).length},removeItem:function(e){delete data[e],this.length=Object.keys(this.data).length},clear:function(){this.data={},this.length=0}},D=function(){function e(){t(this,e),this.storage=this.initStorage()}return r(e,[{key:"initStorage",value:function(){if(I)return I;try{I="undefined"!=typeof window&&null!==window?window.localStorage||window.sessionStorage:null}catch(e){I=null}return I&&!this.isStorageDisabled(I)||(I=S).clear(),I}},{key:"isStorageDisabled",value:function(e){var t="__VASTStorage__";try{if(e.setItem(t,t),e.getItem(t)!==t)return e.removeItem(t),!0}catch(e){return!0}return e.removeItem(t),!1}},{key:"getItem",value:function(e){return this.storage.getItem(e)}},{key:"setItem",value:function(e,t){return this.storage.setItem(e,t)}},{key:"removeItem",value:function(e){return this.storage.removeItem(e)}},{key:"clear",value:function(){return this.storage.clear()}}]),e}(),O=function(){function e(r,i,n){t(this,e),this.cappingFreeLunch=r||0,this.cappingMinimumTimeInterval=i||0,this.defaultOptions={withCredentials:!1,timeout:0},this.vastParser=new x,this.util=new u,this.storage=n||new D,void 0===this.lastSuccessfulAd&&(this.lastSuccessfulAd=0),void 0===this.totalCalls&&(this.totalCalls=0),void 0===this.totalCallsTimeout&&(this.totalCallsTimeout=0)}return r(e,[{key:"getParser",value:function(){return this.vastParser}},{key:"hasRemainingAds",value:function(){return this.vastParser.remainingAds.length>0}},{key:"getNextAds",value:function(e){return this.vastParser.getRemainingAds(e)}},{key:"get",value:function(e){var t=this,r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=Date.now();return(r=Object.assign(this.defaultOptions,r)).hasOwnProperty("resolveAll")||(r.resolveAll=!1),this.totalCallsTimeout<i?(this.totalCalls=1,this.totalCallsTimeout=i+36e5):this.totalCalls++,new Promise(function(n,s){if(t.cappingFreeLunch>=t.totalCalls)return s(new Error("VAST call canceled – FreeLunch capping not reached yet "+t.totalCalls+"/"+t.cappingFreeLunch));var a=i-t.lastSuccessfulAd;if(a<0)t.lastSuccessfulAd=0;else if(a<t.cappingMinimumTimeInterval)return s(new Error("VAST call canceled – ("+t.cappingMinimumTimeInterval+")ms minimum interval reached"));t.vastParser.getAndParseVAST(e,r).then(function(e){return n(e)}).catch(function(e){return s(e)})})}},{key:"lastSuccessfulAd",get:function(){return this.storage.getItem("vast-client-last-successful-ad")},set:function(e){this.storage.setItem("vast-client-last-successful-ad",e)}},{key:"totalCalls",get:function(){return this.storage.getItem("vast-client-total-calls")},set:function(e){this.storage.setItem("vast-client-total-calls",e)}},{key:"totalCallsTimeout",get:function(){return this.storage.getItem("vast-client-total-calls-timeout")},set:function(e){this.storage.setItem("vast-client-total-calls-timeout",e)}}]),e}(),P=function(e){function s(e,r,i){var o=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;t(this,s);var l=n(this,(s.__proto__||Object.getPrototypeOf(s)).call(this));for(var c in l.ad=r,l.creative=i,l.variation=o,l.util=new u,l.muted=!1,l.impressed=!1,l.skippable=!1,l.skipDelayDefault=-1,l.trackingEvents={},l.emitAlwaysEvents=["creativeView","start","firstQuartile","midpoint","thirdQuartile","complete","resume","pause","rewind","skip","closeLinear","close"],l._alreadyTriggeredQuartiles={},l.creative.trackingEvents){var h=l.creative.trackingEvents[c];l.trackingEvents[c]=h.slice(0)}return l.creative instanceof p?(l.setDuration(l.creative.duration),l.skipDelay=l.creative.skipDelay,l.linear=!0,l.clickThroughURLTemplate=l.creative.videoClickThroughURLTemplate,l.clickTrackingURLTemplates=l.creative.videoClickTrackingURLTemplates):(l.skipDelay=-1,l.linear=!1,l.variation&&(l.variation instanceof v?(l.clickThroughURLTemplate=l.variation.nonlinearClickThroughURLTemplate,l.clickTrackingURLTemplates=l.variation.nonlinearClickTrackingURLTemplates):l.variation instanceof a&&(l.clickThroughURLTemplate=l.variation.companionClickThroughURLTemplate,l.clickTrackingURLTemplates=l.variation.companionClickTrackingURLTemplates))),e&&l.on("start",function(){e.lastSuccessfullAd=Date.now()}),l}return i(s,k),r(s,[{key:"setDuration",value:function(e){this.assetDuration=e,this.quartiles={firstQuartile:Math.round(25*this.assetDuration)/100,midpoint:Math.round(50*this.assetDuration)/100,thirdQuartile:Math.round(75*this.assetDuration)/100}}},{key:"setProgress",value:function(e){var t=this,r=this.skipDelay||this.skipDelayDefault;if(-1===r||this.skippable||(r>e?this.emit("skip-countdown",r-e):(this.skippable=!0,this.emit("skip-countdown",0))),this.linear&&this.assetDuration>0){var i=[];if(e>0){var n=Math.round(e/this.assetDuration*100);for(var s in i.push("start"),i.push("progress-"+n+"%"),i.push("progress-"+Math.round(e)),this.quartiles)this.isQuartileReached(s,this.quartiles[s],e)&&(i.push(s),this._alreadyTriggeredQuartiles[s]=!0)}i.forEach(function(e){t.track(e,!0)}),e<this.progress&&this.track("rewind")}this.progress=e}},{key:"isQuartileReached",value:function(e,t,r){var i=!1;return t<=r&&!this._alreadyTriggeredQuartiles[e]&&(i=!0),i}},{key:"setMuted",value:function(e){this.muted!==e&&this.track(e?"mute":"unmute"),this.muted=e}},{key:"setPaused",value:function(e){this.paused!==e&&this.track(e?"pause":"resume"),this.paused=e}},{key:"setFullscreen",value:function(e){this.fullscreen!==e&&this.track(e?"fullscreen":"exitFullscreen"),this.fullscreen=e}},{key:"setExpand",value:function(e){this.expanded!==e&&this.track(e?"expand":"collapse"),this.expanded=e}},{key:"setSkipDelay",value:function(e){"number"==typeof e&&(this.skipDelay=e)}},{key:"trackImpression",value:function(){this.impressed||(this.impressed=!0,this.trackURLs(this.ad.impressionURLTemplates),this.track("creativeView"))}},{key:"errorWithCode",value:function(e){this.trackURLs(this.ad.errorURLTemplates,{ERRORCODE:e})}},{key:"complete",value:function(){this.track("complete")}},{key:"close",value:function(){this.track(this.linear?"closeLinear":"close")}},{key:"skip",value:function(){this.track("skip"),this.trackingEvents=[]}},{key:"click",value:function(){if(this.clickTrackingURLTemplates&&this.clickTrackingURLTemplates.length&&this.trackURLs(this.clickTrackingURLTemplates),this.clickThroughURLTemplate){var e=this.linear?{CONTENTPLAYHEAD:this.progressFormatted()}:{},t=this.util.resolveURLTemplates([this.clickThroughURLTemplate],e)[0];this.emit("clickthrough",t)}}},{key:"track",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];"closeLinear"===e&&!this.trackingEvents[e]&&this.trackingEvents.close&&(e="close");var r=this.trackingEvents[e],i=this.emitAlwaysEvents.indexOf(e)>-1;r?(this.emit(e,""),this.trackURLs(r)):i&&this.emit(e,""),t&&(delete this.trackingEvents[e],i&&this.emitAlwaysEvents.splice(this.emitAlwaysEvents.indexOf(e),1))}},{key:"trackURLs",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};this.linear&&(this.creative&&this.creative.mediaFiles&&this.creative.mediaFiles[0]&&this.creative.mediaFiles[0].fileURL&&(t.ASSETURI=this.creative.mediaFiles[0].fileURL),t.CONTENTPLAYHEAD=this.progressFormatted()),this.util.track(e,t)}},{key:"progressFormatted",value:function(){var e=parseInt(this.progress),t=e/3600;t.length<2&&(t="0"+t);var r=e/60%60;r.length<2&&(r="0"+r);var i=e%60;return i.length<2&&(i="0"+r),t+":"+r+":"+i+"."+parseInt(100*(this.progress-e))}}]),s}();return e.VASTClient=O,e.VASTParser=x,e.VASTTracker=P,e}({});
